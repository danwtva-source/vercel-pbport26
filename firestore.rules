rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function hasRole(role) {
      return isSignedIn() && getUserData().role == role;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // --- COLLECTION RULES ---

    // USERS: Users can read/write their own profile. Admins can read/write all.
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn(); // Allow initial signup
      allow update: if isOwner(userId) || hasRole('admin');
      allow delete: if hasRole('admin');
    }

    // APPLICATIONS: 
    // - Applicants can read/write their own.
    // - Committee can read applications in their area.
    // - Admins can read/write all.
    match /applications/{appId} {
      allow create: if isSignedIn();
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid || 
        hasRole('admin') || 
        (hasRole('committee') && (resource.data.area == getUserData().area || resource.data.area == 'Cross-Area'))
      );
      allow update: if isSignedIn() && (
        resource.data.userId == request.auth.uid || 
        hasRole('admin')
      );
      allow delete: if hasRole('admin') || (resource.data.userId == request.auth.uid && resource.data.status == 'Draft');
    }

    // VOTES & SCORES:
    // - Committee members can create votes/scores.
    // - Admins can read all.
    match /votes/{voteId} {
      allow read: if hasRole('admin') || (isSignedIn() && resource.data.voterId == request.auth.uid);
      allow create: if hasRole('committee') || hasRole('admin');
    }

    match /scores/{scoreId} {
      allow read: if hasRole('admin') || (isSignedIn() && resource.data.scorerId == request.auth.uid);
      allow create, update: if hasRole('committee') || hasRole('admin');
    }

    // ROUNDS & SETTINGS: Read-only for most, Admin write.
    match /rounds/{roundId} {
      allow read: if true;
      allow write: if hasRole('admin');
    }
    
    match /portalSettings/{settingId} {
      allow read: if true;
      allow write: if hasRole('admin');
    }

    // AUDIT LOGS: Admin only.
    match /auditLogs/{logId} {
      allow read: if hasRole('admin');
      allow write: if hasRole('admin'); // Typically written via Admin SDK/Cloud Functions, but allowing Admin user for prototype
    }
    
    // ADMIN DOCS
    match /adminDocuments/{docId} {
      allow read: if hasRole('admin') || hasRole('committee');
      allow write: if hasRole('admin');
    }
    
    // ASSIGNMENTS
    match /assignments/{assignmentId} {
       allow read: if hasRole('admin') || (hasRole('committee') && resource.data.committeeId == request.auth.uid);
       allow write: if hasRole('admin');
    }
  }
}
